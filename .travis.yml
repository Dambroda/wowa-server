language: node_js
node_js: 10.12
# every second counts
git:
  depth: 5
services: docker
env:
  - NODE_ENV=production

cache:
  directories:
    - server/node_modules
install:
  - npm install --dev && cd ..
script:
  - npm run test:once -- --maxWorkers=2 && cd ..
  - docker build --tag wowanalyzer-server .
# Reminder: deploy doesn't run on PRs
deploy:
  provider: script
  skip_cleanup: true
  script: bash .docker/production/deploy.sh
  on:
    all_branches: true
after_failure:
  - chmod +x .travis/discord-hook/fail.sh
  - ./.travis/discord-hook/fail.sh
notifications:
  webhooks: https://www.travisbuddy.com/
  on_success: never
